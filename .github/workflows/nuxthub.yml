name: Deploy to NuxtHub
on: push

jobs:
  deploy:
    name: "Deploy to NuxtHub"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: bun install

      - name: Ensure NuxtHub module is installed
        run: bunx nuxthub@latest ensure

      - name: Build Nuxt
        run: |
          # Build Nuxt/Nitro (use nuxi via bunx)
          bunx nuxi build

      - name: Prepare dist directory for NuxtHub
        run: |
          # Prefer static public output if present (for static deployments)
          if [ -d .output/public ]; then
            rm -rf dist
            cp -r .output/public dist
            echo "Prepared dist from .output/public"
          else
            # Fallback: copy entire .output (for server deployments)
            rm -rf dist
            cp -r .output dist
            echo "Prepared dist from .output"
          fi

      - name: Deploy to NuxtHub (CLI)
        env:
          NUXT_HUB_USER_TOKEN: ${{ secrets.NUXT_HUB_USER_TOKEN }}
        run: |
          # Use the NuxtHub CLI to deploy the prepared dist directory
          bunx nuxthub@latest deploy --project-key=app-aissp-4dkl --dir=dist
